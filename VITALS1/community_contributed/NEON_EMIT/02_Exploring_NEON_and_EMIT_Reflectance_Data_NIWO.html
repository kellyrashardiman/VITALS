<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2 Working with EMIT L2A Reflectance and NEON L3 Directional Reflectance Data – VITALS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-8ef56b68f8fa1e9d2ba328e99e439f80.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-bb05f5d0074da2129d766b238819cd35.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-da07cd31545148f957c25e8e93bd3f75.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-bb05f5d0074da2129d766b238819cd35.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">2.1 Setup</a></li>
  <li><a href="#opening-and-exploring-emit-reflectance-data" id="toc-opening-and-exploring-emit-reflectance-data" class="nav-link" data-scroll-target="#opening-and-exploring-emit-reflectance-data">2.2 Opening and Exploring EMIT Reflectance Data</a>
  <ul class="collapse">
  <li><a href="#applying-quality-masks-to-emit-data" id="toc-applying-quality-masks-to-emit-data" class="nav-link" data-scroll-target="#applying-quality-masks-to-emit-data">2.2.1 Applying Quality Masks to EMIT Data</a></li>
  <li><a href="#interactive-spectral-plots" id="toc-interactive-spectral-plots" class="nav-link" data-scroll-target="#interactive-spectral-plots">2.2.2 Interactive Spectral Plots</a></li>
  <li><a href="#cropping-emit-data-to-a-region-of-interest" id="toc-cropping-emit-data-to-a-region-of-interest" class="nav-link" data-scroll-target="#cropping-emit-data-to-a-region-of-interest">2.2.3 Cropping EMIT data to a Region of Interest</a></li>
  <li><a href="#write-an-output" id="toc-write-an-output" class="nav-link" data-scroll-target="#write-an-output">2.2.4 Write an output</a></li>
  </ul></li>
  <li><a href="#working-with-neon-hyperspectral-reflectance-data" id="toc-working-with-neon-hyperspectral-reflectance-data" class="nav-link" data-scroll-target="#working-with-neon-hyperspectral-reflectance-data">3.0 Working with NEON Hyperspectral Reflectance Data</a></li>
  <li><a href="#contact-info" id="toc-contact-info" class="nav-link" data-scroll-target="#contact-info">Contact Info:</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">2 Working with EMIT L2A Reflectance and NEON L3 Directional Reflectance Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Summary</strong></p>
<p>In the previous notebook, we found and downloaded co-located EMIT L2A Reflectance and NEON L3 Airborne Reflectance data over the NEON Niwot Ridge site in Colorado. In this notebook, we will open and explore both datasets to better understand the structure, then we will conduct some common preprocessing routines to work with the data together, including: applying quality data information, reprojecting, placing data on a common grid, and cropping.</p>
<div>
<p><img src="./neon_notebook_figs/NEON_NIWO_Spectra.png" width="750"></p>
</div>
<p><strong>Background</strong></p>
<p>The <strong>EMIT</strong> instrument is an imaging spectrometer that measures light in visible and infrared wavelengths. These measurements display unique spectral signatures that correspond to the composition on the Earth’s surface. The EMIT mission focuses specifically on mapping the composition of minerals to better understand the effects of mineral dust throughout the Earth system and human populations now and in the future. In addition, the EMIT instrument can be used in other applications, such as mapping of greenhouse gases, snow properties, and water resources.</p>
<p>More details about EMIT and its associated products can be found on the <a href="https://earth.jpl.nasa.gov/emit/">EMIT website</a> and <a href="https://lpdaac.usgs.gov/product_search/?query=EMIT&amp;status=Operational&amp;view=cards&amp;sort=title">EMIT product pages</a> hosted by the LP DAAC.</p>
<p>The <strong>NEON Imaging Spectrometer (NIS)</strong> is an airborne <a href="https://www.neonscience.org/data-collection/imaging-spectrometer">imaging spectrometer</a> built by JPL (AVIRIS-NG) and operated by the National Ecological Observatory Network’s (NEON) Airborne Observation Platform (AOP). NEON’s hyperspectral sensors collect measurements of sunlight reflected from the Earth’s surface in 426 narrow (~5 nm) spectral channels spanning wavelengths between ~ 380 - 2500 nm. NEON’s remote sensing data is intended to map and answer questions about a landscape, with ecological applications including identifying and classifying plant species and communities, mapping vegetation health, detecting disease or invasive species, and mapping droughts, wildfires, or other natural disturbances and their impacts.</p>
<p>NEON surveys sites spanning the Continental US, Alaska, Hawaii<em>, and Puerto Rico</em>, during peak phenological greenness, capturing each site 3 out of every 5 years, for most terrestrial sites (*Hawaii and Puerto Rico are surveyed ~1 out of every 4-5 years). AOP’s <a href="https://www.neonscience.org/data-collection/flight-schedules-coverage">Flight Schedules and Coverage</a> provides more information about current and past airborne schedules.</p>
<p>More detailed information about NEON’s airborne sampling design can be found in the paper: <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.13942">Spanning scales: The airborne spatial and temporal sampling design of the National Ecological Observatory Network</a>.</p>
<p><strong>References</strong><br>
- Leith, Alex. 2023. Hyperspectral Notebooks. Jupyter Notebook. Auspatious. https://github.com/auspatious/hyperspectral-notebooks/tree/main - Musinsky et al.&nbsp;2022. Spanning Scales: the airborne spatial and temporal sampling design o the National Ecological Observatory Network.</p>
<p><strong>Requirements</strong><br>
- <a href="https://urs.earthdata.nasa.gov/home">NASA Earthdata Account</a><br>
- <em>No Python setup requirements if connected to the workshop cloud instance!</em><br>
- <strong>Local Only</strong> Set up Python Environment - See <strong>setup_instructions.md</strong> in the <code>/setup/</code> folder to set up a local compatible Python environment<br>
- Downloaded necessary files. This is done at the end of the <a href="01_Finding_Co-located_Data_NIWO.ipynb">01_Finding_Co-located_Data_NIWO</a> notebook.</p>
<p><strong>Learning Objectives</strong><br>
- How to open and work with EMIT L2A Reflectance and NEON L3 Hyperspectral Reflectance data<br>
- How to apply a quality mask to EMIT datasets<br>
- How to reproject and regrid data<br>
- How to crop EMIT data - How to interactively explore the Reflectance Spectra at multiple scales</p>
<p><strong>Tutorial Outline</strong></p>
<p>2.1 Setup<br>
2.2 Opening and Exploring EMIT Reflectance Data<br>
2.2.1 Applying Quality Masks to EMIT Data<br>
2.2.2 Interactive Plots<br>
2.2.3 Cropping EMIT Data<br>
2.2.4 Writing Outputs<br>
2.3 Opening and Exploring NEON Reflectance Data<br>
2.3.1 Interactive Plots 2.3.2 Writing Outputs</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">2.1 Setup</h2>
<p>Import Python libraries.</p>
<div id="cell-3" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, sys</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> osgeo <span class="im">import</span> gdal</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hvplot.xarray</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hvplot.pandas</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> holoviews <span class="im">as</span> hv</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'../../python/modules'</span> <span class="kw">not</span> <span class="kw">in</span> sys.path:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    sys.path.append(<span class="st">'../../python/modules'</span>) </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> emit_tools <span class="im">import</span> emit_xarray</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#import geoviews as gv</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#from holoviews.plotting.links import DataLink</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a filepath for an EMIT L2A Reflectance file and EMIT L2A Mask file. The files selected in this example are from June 22, 2023, at around 19:32.</p>
<div id="cell-6" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>emit_fp <span class="op">=</span> <span class="st">"./data/emit_refl/EMIT_L2A_RFL_001_20230625T170814_2317611_005.nc"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>emit_qa_fp <span class="op">=</span> <span class="st">"./data/emit_refl/EMIT_L2A_MASK_001_20230625T170814_2317611_005.nc"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="opening-and-exploring-emit-reflectance-data" class="level2">
<h2 class="anchored" data-anchor-id="opening-and-exploring-emit-reflectance-data">2.2 Opening and Exploring EMIT Reflectance Data</h2>
<p>EMIT L2A Reflectance Data are distributed in a non-orthocorrected spatially raw NetCDF4 (.nc) format consisting of the data and its associated metadata. Inside the L2A Reflectance <code>.nc</code> file there are 3 groups. Groups can be thought of as containers to organize the data.</p>
<ol type="1">
<li>The root group that can be considered the main dataset contains the reflectance data described by the downtrack, crosstrack, and bands dimensions.<br>
</li>
<li>The <code>sensor_band_parameters</code> group containing the wavelength center and the full-width half maximum (FWHM) of each band.<br>
</li>
<li>The <code>location</code> group contains latitude and longitude values at the center of each pixel described by the crosstrack and downtrack dimensions, as well as a geometry lookup table (GLT) described by the ortho_x and ortho_y dimensions. The GLT is an orthorectified image (EPSG:4326) consisting of 2 layers containing downtrack and crosstrack indices. These index positions allow us to quickly project the raw data onto this geographic grid.</li>
</ol>
<p>To work with the EMIT data, we will use the <code>emit_tools</code> module. There are other ways to work with the data and a more thorough explanation of the <code>emit_tools</code> in the <a href="https://github.com/nasa/EMIT-Data-Resources">EMIT-Data-Resources Repository</a>.</p>
<p>Open the example EMIT scene using the <code>emit_xarray</code> function. In this step we will use the <code>ortho=True</code> argument to orthorectify the scene using the included GLT.</p>
<div id="cell-8" class="cell" data-scrolled="true" data-tags="[]">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>emit_ds <span class="op">=</span> emit_xarray(emit_fp, ortho<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>emit_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>emit_ds.coords[<span class="st">'spatial_ref'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the spectra of an individual pixel closest to a latitude and longitude we want using the <code>sel</code> function from <code>xarray</code>. Using the <code>good_wavelengths</code> flag from the <code>sensor_band_parameters</code> group, mask out bands where water absorption features were assigned a value of -0.01 reflectance. Typically data around 1320-1440 nm and 1770-1970 nm is noisy due to the moisture present in the atmosphere; therefore, these spectral regions offer little information about targets and can be excluded from calculations.</p>
<div id="cell-11" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>emit_ds[<span class="st">'reflectance'</span>].data[:,:,emit_ds[<span class="st">'good_wavelengths'</span>].data<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now select a point and plot a spectra. In this example, we’ll first find the center of the scene and use those coordinates.</p>
<div id="cell-13" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>scene_center <span class="op">=</span> emit_ds.latitude.values[<span class="bu">int</span>(<span class="bu">len</span>(emit_ds.latitude)<span class="op">/</span><span class="dv">2</span>)],emit_ds.longitude.values[<span class="bu">int</span>(<span class="bu">len</span>(emit_ds.longitude)<span class="op">/</span><span class="dv">2</span>)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>scene_center</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>point <span class="op">=</span> emit_ds.sel(latitude<span class="op">=</span>scene_center[<span class="dv">0</span>],longitude<span class="op">=</span>scene_center[<span class="dv">1</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>point.hvplot.line(y<span class="op">=</span><span class="st">'reflectance'</span>,x<span class="op">=</span><span class="st">'wavelengths'</span>, color<span class="op">=</span><span class="st">'black'</span>).opts(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f'Latitude = </span><span class="sc">{</span>point<span class="sc">.</span>latitude<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">, Longitude = </span><span class="sc">{</span>point<span class="sc">.</span>longitude<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also plot individual bands spatially by selecting a wavelength, then plotting. First mask out <code>fill_values</code> introduced during the orthorectification process by assigning their values to <code>nan</code>. Then select the band with a wavelengths of 850 nm and plot it using ESRI imagery as a basemap to get a better picture of the scene.</p>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>emit_ds[<span class="st">'reflectance'</span>].data[emit_ds[<span class="st">'reflectance'</span>].data <span class="op">==</span> <span class="op">-</span><span class="dv">9999</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>emit_layer <span class="op">=</span> emit_ds.sel(wavelengths<span class="op">=</span><span class="dv">850</span>,method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>emit_layer.hvplot.image(cmap<span class="op">=</span><span class="st">'viridis'</span>,geo<span class="op">=</span><span class="va">True</span>, tiles<span class="op">=</span><span class="st">'ESRI'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>, frame_width<span class="op">=</span><span class="dv">720</span>,frame_height<span class="op">=</span><span class="dv">405</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, fontscale<span class="op">=</span><span class="dv">2</span>).opts(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>emit_layer<span class="sc">.</span>wavelengths<span class="sc">:.3f}</span><span class="ss"> </span><span class="sc">{</span>emit_layer<span class="sc">.</span>wavelengths<span class="sc">.</span>units<span class="sc">}</span><span class="ss">"</span>, xlabel<span class="op">=</span><span class="st">'Longitude'</span>,ylabel<span class="op">=</span><span class="st">'Latitude'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="applying-quality-masks-to-emit-data" class="level3">
<h3 class="anchored" data-anchor-id="applying-quality-masks-to-emit-data">2.2.1 Applying Quality Masks to EMIT Data</h3>
<p>The EMIT L2A Mask file contains some bands that are direct masks (Cloud, Dilated, Cirrus, Water, Spacecraft), and some (AOD550 and H2O (g cm-2)) that contain information calculated during the L2A reflectance retrieval. These may be used as additional screening, depending on the application. The Aggregate Flag is the mask used during EMIT L2B Mineralogy calculations, which we will also use here, but not all users might want this particular mask.</p>
<blockquote class="blockquote">
<p>Note: It is more memory efficient to apply the mask before orthorectifying, so during the automation section we will do that.</p>
</blockquote>
<div id="cell-19" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>emit_mask <span class="op">=</span> emit_xarray(emit_qa_fp, ortho<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>emit_mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># optionally look at the info</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># emit_mask.info()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>List the quality flags contained in the <code>mask_bands</code> dimension.</p>
<div id="cell-22" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>emit_mask.mask_bands.data.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As mentioned, we will use the <code>Aggregate Flag</code>. First mask areas with <code>fill_value</code> of -9999 like we did for reflectence, then select the <code>Aggregate Flag</code> band with the <code>sel</code> function as we did for wavelengths before.</p>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>emit_mask[<span class="st">'mask'</span>].data[emit_mask[<span class="st">'mask'</span>].data <span class="op">==</span> <span class="op">-</span><span class="dv">9999</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-25" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>emit_aggregate_mask <span class="op">=</span> emit_mask.sel(mask_bands<span class="op">=</span><span class="st">'Aggregate Flag'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can visualize our aggregate quality mask. You may have noticed before that we added a lot of parameters to our plotting function. If we want to consistently apply the same formatting for multiple plots, we can add those arguments to a dictionary that we can unpack into <code>hvplot</code> functions using <code>**</code>.</p>
<p>Create two dictionaries with plotting options.</p>
<div id="cell-27" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>size_opts <span class="op">=</span> <span class="bu">dict</span>(frame_height<span class="op">=</span><span class="dv">405</span>, frame_width<span class="op">=</span><span class="dv">720</span>, fontscale<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>map_opts <span class="op">=</span> <span class="bu">dict</span>(geo<span class="op">=</span><span class="va">True</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, xlabel<span class="op">=</span><span class="st">'Longitude'</span>,ylabel<span class="op">=</span><span class="st">'Latitude'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>emit_aggregate_mask.hvplot.image(cmap<span class="op">=</span><span class="st">'viridis'</span>, tiles<span class="op">=</span><span class="st">'ESRI'</span>, <span class="op">**</span>size_opts, <span class="op">**</span>map_opts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Values of 1 in the mask indicate areas to omit. Apply the mask to our EMIT Data by assigning values where the <code>mask.data == 1</code> to <code>np.nan</code></p>
<div id="cell-30" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>emit_ds.reflectance.data[emit_aggregate_mask.mask.data <span class="op">==</span> <span class="dv">1</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can confirm our masking worked with a spatial plot.</p>
<div id="cell-32" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>emit_layer_filtered_plot <span class="op">=</span> emit_ds.sel(wavelengths<span class="op">=</span><span class="dv">850</span>, method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.image(cmap<span class="op">=</span><span class="st">'viridis'</span>,tiles<span class="op">=</span><span class="st">'ESRI'</span>,<span class="op">**</span>size_opts, <span class="op">**</span>map_opts)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>emit_layer_filtered_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interactive-spectral-plots" class="level3">
<h3 class="anchored" data-anchor-id="interactive-spectral-plots">2.2.2 Interactive Spectral Plots</h3>
<p>Combining the Spatial and Spectral information into a single visualization can be a powerful tool for exploring and inspecting imaging spectroscopy data. Using the streams module from Holoviews we can link a spatial map to a plot of spectra.</p>
<p>We could plot a single band image as we previously have, but using a multiband image, like an RGB may help infer what targets we’re examining. Build an RGB image following the steps below.</p>
<p>Select bands to represent red (650 nm), green (560 nm), and blue (470 nm) by finding the nearest to a wavelength chosen to represent that color.</p>
<div id="cell-34" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>emit_rgb <span class="op">=</span> emit_ds.sel(wavelengths<span class="op">=</span>[<span class="dv">650</span>, <span class="dv">560</span>, <span class="dv">470</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We may need to adjust balance the brightness of the selected wavelengths to make a prettier map. <strong>This will not affect the data, just the visuals.</strong> To do this we will use the function below. We can change the <code>bright</code> argument to increase or decrease the brightness of the scene as a whole. A value of 0.2 usually works pretty well.</p>
<div id="cell-36" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gamma_adjust(rgb_ds, bright<span class="op">=</span><span class="fl">0.2</span>, white_background<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    array <span class="op">=</span> rgb_ds.reflectance.data</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> math.log(bright)<span class="op">/</span>math.log(np.nanmean(array)) <span class="co"># Create exponent for gamma scaling - can be adjusted by changing 0.2 </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    scaled <span class="op">=</span> np.power(np.nan_to_num(array,nan<span class="op">=</span><span class="dv">1</span>),np.nan_to_num(gamma,nan<span class="op">=</span><span class="dv">1</span>)).clip(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co"># Apply scaling and clip to 0-1 range</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> white_background <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        scaled <span class="op">=</span> np.nan_to_num(scaled, nan <span class="op">=</span> <span class="dv">1</span>) <span class="co"># Set NANs to 1 so they appear white in plots</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    rgb_ds.reflectance.data <span class="op">=</span> scaled</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-37" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>emit_rgb <span class="op">=</span> gamma_adjust(emit_rgb, white_background<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have an RGB dataset, we can use that to create a spatial plot, and data selected by clicking on that ‘map’ can be inputs for a function to return values from the full dataset at that latitude and longitude location using the cell below. To visualize the spectral and spatial data side-by-side, we use the Point Draw tool from the holoviews library.</p>
<p>Define a limit to the quantity of points and spectra we will plot, a list of colors to cycle through, and an initial point. Then use the input from the Tap function to provide clicked x and y positions on the map and use these to retrieve spectra from the dataset at those coordinates.</p>
<p>Click in the RGB image to add spectra to the plot. You can also click and hold the mouse button then drag previously place points. To remove a point click and hold the mouse button down, then press the backspace key.</p>
<div id="cell-39" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive Points Plotting</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modified from https://github.com/auspatious/hyperspectral-notebooks/blob/main/03_EMIT_Interactive_Points.ipynb</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>POINT_LIMIT <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>color_cycle <span class="op">=</span> hv.Cycle(<span class="st">'Category20'</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RGB Map</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">=</span> emit_rgb.hvplot.rgb(fontscale<span class="op">=</span><span class="fl">1.5</span>, xlabel<span class="op">=</span><span class="st">'Longitude'</span>,ylabel<span class="op">=</span><span class="st">'Latitude'</span>,frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a holoviews points array to enable plotting of the clicked points</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>xmid <span class="op">=</span> emit_ds.longitude.values[<span class="bu">int</span>(<span class="bu">len</span>(emit_ds.longitude) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>ymid <span class="op">=</span> emit_ds.latitude.values[<span class="bu">int</span>(<span class="bu">len</span>(emit_ds.latitude) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>first_point <span class="op">=</span> ([xmid], [ymid], [<span class="dv">0</span>])</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> hv.Points(first_point, vdims<span class="op">=</span><span class="st">'id'</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>points_stream <span class="op">=</span> hv.streams.PointDraw(</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>points.columns(),</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>points,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    drag<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    num_objects<span class="op">=</span>POINT_LIMIT,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span>{<span class="st">'fill_color'</span>: color_cycle.values[<span class="dv">1</span>:POINT_LIMIT<span class="op">+</span><span class="dv">1</span>], <span class="st">'line_color'</span>: <span class="st">'gray'</span>}</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>posxy <span class="op">=</span> hv.streams.PointerXY(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>clickxy <span class="op">=</span> hv.streams.Tap(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to build spectral plot of clicked location to show on hover stream plot</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> click_spectra(data):</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> []</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> <span class="bu">any</span>(<span class="bu">len</span>(d) <span class="cf">for</span> d <span class="kw">in</span> data.values()):</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        coordinates.append(clicked_points[<span class="dv">0</span>][<span class="dv">0</span>], clicked_points[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        coordinates <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">'x'</span>], data[<span class="st">'y'</span>])]</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    plots <span class="op">=</span> []</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, coords <span class="kw">in</span> <span class="bu">enumerate</span>(coordinates):</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> coords</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> emit_ds.sel(longitude<span class="op">=</span>x, latitude<span class="op">=</span>y, method<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        plots.append(</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            data.hvplot.line(</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span><span class="st">"reflectance"</span>,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">"wavelengths"</span>,</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color_cycle,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        points_stream.data[<span class="st">"id"</span>][i] <span class="op">=</span> i</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hv.Overlay(plots)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hover_spectra(x,y):</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> emit_ds.sel(longitude<span class="op">=</span>x,latitude<span class="op">=</span>y,method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.line(y<span class="op">=</span><span class="st">'reflectance'</span>,x<span class="op">=</span><span class="st">'wavelengths'</span>,</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>                                                                            color<span class="op">=</span><span class="st">'black'</span>, frame_width<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Dynamic Maps</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>click_dmap <span class="op">=</span> hv.DynamicMap(click_spectra, streams<span class="op">=</span>[points_stream])</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>hover_dmap <span class="op">=</span> hv.DynamicMap(hover_spectra, streams<span class="op">=</span>[posxy])</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Map and Dynamic Map side by side</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>hv.Layout(hover_dmap<span class="op">*</span>click_dmap <span class="op">+</span> <span class="bu">map</span> <span class="op">*</span> points).cols(<span class="dv">2</span>).opts(</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    hv.opts.Points(active_tools<span class="op">=</span>[<span class="st">'point_draw'</span>], size<span class="op">=</span><span class="dv">10</span>, tools<span class="op">=</span>[<span class="st">'hover'</span>], color<span class="op">=</span><span class="st">'white'</span>, line_color<span class="op">=</span><span class="st">'gray'</span>),</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    hv.opts.Overlay(show_legend<span class="op">=</span><span class="va">False</span>, show_title<span class="op">=</span><span class="va">False</span>, fontscale<span class="op">=</span><span class="fl">1.5</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can take these selected points and the corresponding reflectance spectra and save them as a <code>.csv</code> for later use.</p>
<p>Select 10 points by adding to the figure above. We will save these and use them in a to calculate Equivalent Water Thickness or Canopy water content in the next notebook.</p>
<p>Build a dictionary of the selected points and spectra, then export the spectra to a .csv file.</p>
<div id="cell-43" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> points_stream.data</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>wavelengths <span class="op">=</span> emit_ds.wavelengths.values</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> [[<span class="st">"id"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>] <span class="op">+</span> [<span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> wavelengths]]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">'x'</span>], data[<span class="st">'y'</span>], data[<span class="st">'id'</span>]):</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    x, y, i <span class="op">=</span> p</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    spectra <span class="op">=</span> emit_ds.sel(longitude<span class="op">=</span>x, latitude<span class="op">=</span>y, method<span class="op">=</span><span class="st">"nearest"</span>).reflectance.values</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> [i, x, y] <span class="op">+</span> <span class="bu">list</span>(spectra)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    rows.append(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve preselected 10 points, but feel free to uncomment the cell below to use your own. This will overwrite the file containing the preselected points.</p>
<div id="cell-45" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('../data/emit_click_data.csv', 'w', newline='') as f:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     writer = csv.writer(f)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     writer.writerows(rows)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cropping-emit-data-to-a-region-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="cropping-emit-data-to-a-region-of-interest">2.2.3 Cropping EMIT data to a Region of Interest</h3>
<p>To crop our dataset to our ROI, we first need to open a shapefile of the region. Open the downloaded <code>shapefile</code> of all AOP flight boxes, filter to the Niwot Ridge site (NIWO) and plot it onto the EMIT 850nm reflectance spatial plot. To ensure proper georeferencing of the EMIT scene, be sure to specify the CRS (this is done for the image in the <code>map_opts</code> dictionary).</p>
<div id="cell-47" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># shape = gp.read_file("../data/dangermond_boundary.geojson")</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>aop_flightboxes <span class="op">=</span> gp.read_file(<span class="st">"./data/AOP_flightBoxes/AOP_flightboxesAllSites.shp"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>niwo_polygon <span class="op">=</span> aop_flightboxes[aop_flightboxes.siteID <span class="op">==</span> <span class="st">'NIWO'</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>shape <span class="op">=</span> niwo_polygon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell" data-scrolled="true" data-tags="[]">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>emit_ds.sel(wavelengths<span class="op">=</span><span class="dv">850</span>, method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.image(cmap<span class="op">=</span><span class="st">'viridis'</span>,<span class="op">**</span>size_opts,<span class="op">**</span>map_opts,tiles<span class="op">=</span><span class="st">'ESRI'</span>)<span class="op">*</span>shape.hvplot(color<span class="op">=</span><span class="st">'#FFFF00'</span>,alpha<span class="op">=</span><span class="fl">0.5</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now use the <code>clip</code> function from <code>rasterio</code> to crop the data to our ROI using our shape’s <code>geometry</code> and <code>crs</code>. The <code>all_touched=True</code> argument will ensure all pixels touched by our polygon will be included.</p>
<div id="cell-50" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>emit_cropped <span class="op">=</span> emit_ds.rio.clip(shape.geometry.values,shape.crs, all_touched<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot the cropped data.</p>
<div id="cell-52" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>emit_cropped.sel(wavelengths<span class="op">=</span><span class="dv">850</span>,method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.image(cmap<span class="op">=</span><span class="st">'viridis'</span>, tiles<span class="op">=</span><span class="st">'ESRI'</span>, <span class="op">**</span>size_opts, <span class="op">**</span>map_opts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RGB Map of the cropped dataset</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>emit_rgb_cropped <span class="op">=</span> emit_cropped.sel(wavelengths<span class="op">=</span>[<span class="dv">650</span>, <span class="dv">560</span>, <span class="dv">470</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>emit_rgb_cropped <span class="op">=</span> gamma_adjust(emit_rgb_cropped,white_background<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>emit_rgb_cropped.hvplot.rgb(fontscale<span class="op">=</span><span class="fl">1.5</span>, xlabel<span class="op">=</span><span class="st">'Longitude'</span>,ylabel<span class="op">=</span><span class="st">'Latitude'</span>,title <span class="op">=</span> <span class="st">'EMIT RGB Image over Niwot Ridge AOP Flight Box'</span>,geo <span class="op">=</span> <span class="va">True</span>, frame_width <span class="op">=</span> <span class="dv">600</span>) <span class="co">#frame_width=560, frame_height=480)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="write-an-output" class="level3">
<h3 class="anchored" data-anchor-id="write-an-output">2.2.4 Write an output</h3>
<p>Lastly for our EMIT dataset, we can write a smaller output that we can use in later notebooks, to calculate Canopy water content or other applications. We use the <code>granule_id</code> from the dataset to keep a similar naming convention.</p>
<div id="cell-55" class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Write Clipped Output</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>emit_cropped.to_netcdf(<span class="ss">f'./data/</span><span class="sc">{</span>emit_cropped<span class="sc">.</span>granule_id<span class="sc">}</span><span class="ss">_NIWO.nc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="working-with-neon-hyperspectral-reflectance-data" class="level2">
<h2 class="anchored" data-anchor-id="working-with-neon-hyperspectral-reflectance-data">3.0 Working with NEON Hyperspectral Reflectance Data</h2>
<p>For this example we’ll take a look at the Level-3 (1km x 1km tiled) NEON AOP directional surface reflectance data (DP3.30006.001).</p>
<p>First, we’ll define a function to convert from the hdf5 format into xarray so we can look at this data in a similar way to the EMIT data.</p>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aop_h5refl2xarray(h5_filename):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> h5py.File(h5_filename) <span class="im">as</span> hdf5_file:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Reading in '</span>, h5_filename)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        sitename <span class="op">=</span> <span class="bu">list</span>(hdf5_file.keys())[<span class="dv">0</span>]  <span class="co"># Adjusted to directly access the first key</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        h5_refl_group <span class="op">=</span> hdf5_file[sitename][<span class="st">'Reflectance'</span>]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        refl_dataset <span class="op">=</span> h5_refl_group[<span class="st">'Reflectance_Data'</span>]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        refl_array <span class="op">=</span> refl_dataset[()]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        refl_shape <span class="op">=</span> refl_array.shape</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        wavelengths <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Spectral_Data'</span>][<span class="st">'Wavelength'</span>][:]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        fwhm <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Spectral_Data'</span>][<span class="st">'FWHM'</span>][:]</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create dictionary containing metadata information</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> {}</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'shape'</span>] <span class="op">=</span> refl_shape</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'no_data_value'</span>] <span class="op">=</span> <span class="bu">float</span>(</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>            refl_dataset.attrs[<span class="st">'Data_Ignore_Value'</span>])</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'scale_factor'</span>] <span class="op">=</span> <span class="bu">float</span>(refl_dataset.attrs[<span class="st">'Scale_Factor'</span>])</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the scale factor &amp; Scale the reflectance data by the scale factor - this is memory intensive though!</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Can do it after the fact</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># scale_factor = float(refl_dataset.attrs['Scale_Factor'])</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># refl_array = refl_array.astype(float) / scale_factor</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract bad band windows</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'bad_band_window1'</span>] <span class="op">=</span> (</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            h5_refl_group.attrs[<span class="st">'Band_Window_1_Nanometers'</span>])</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'bad_band_window2'</span>] <span class="op">=</span> (</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            h5_refl_group.attrs[<span class="st">'Band_Window_2_Nanometers'</span>])</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize good_wavelengths array with 1s</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        good_wavelengths <span class="op">=</span> np.ones_like(wavelengths, dtype<span class="op">=</span><span class="st">'float32'</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mark wavelengths within the bad band windows as 0</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bad_window <span class="kw">in</span> [metadata[<span class="st">'bad_band_window1'</span>], metadata[<span class="st">'bad_band_window2'</span>]]:</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>            bad_indices <span class="op">=</span> np.where((wavelengths <span class="op">&gt;=</span> bad_window[<span class="dv">0</span>]) <span class="op">&amp;</span> (wavelengths <span class="op">&lt;=</span> bad_window[<span class="dv">1</span>]))[<span class="dv">0</span>]</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>            good_wavelengths[bad_indices] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        good_wavelengths[<span class="op">-</span><span class="dv">10</span>:] <span class="op">=</span> <span class="dv">0</span> <span class="co"># the last 10 indices also tend to be noisy</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'projection'</span>] <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Proj4'</span>][()].decode(<span class="st">'utf-8'</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'spatial_ref'</span>] <span class="op">=</span> h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Coordinate_System_String'</span>][()].decode(<span class="st">'utf-8'</span>)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'EPSG'</span>] <span class="op">=</span> <span class="bu">int</span>(h5_refl_group[<span class="st">'Metadata'</span>]</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>                               [<span class="st">'Coordinate_System'</span>][<span class="st">'EPSG Code'</span>][()])</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        map_info <span class="op">=</span> <span class="bu">str</span>(</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            h5_refl_group[<span class="st">'Metadata'</span>][<span class="st">'Coordinate_System'</span>][<span class="st">'Map_Info'</span>][()]).split(<span class="st">","</span>)</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract the resolution &amp; convert to floating decimal number</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>        pixel_width <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">5</span>])</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>        pixel_height <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">6</span>])</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract the upper left-hand corner coordinates from mapInfo and cast to float</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        x_min <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">3</span>])</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        y_max <span class="op">=</span> <span class="bu">float</span>(map_info[<span class="dv">4</span>])</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate the xMax and yMin values from the dimensions</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># xMax = left edge + (# of columns * resolution)\n",</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>        x_max <span class="op">=</span> x_min <span class="op">+</span> (refl_shape[<span class="dv">1</span>]<span class="op">*</span><span class="bu">float</span>(pixel_width))</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># yMin = top edge - (# of rows * resolution)\n",</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>        y_min <span class="op">=</span> y_max <span class="op">-</span> (refl_shape[<span class="dv">0</span>]<span class="op">*</span><span class="bu">float</span>(pixel_height))</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'extent'</span>] <span class="op">=</span> (x_min, x_max, y_min, y_max)</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'ext_dict'</span>] <span class="op">=</span> {}</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'ext_dict'</span>][<span class="st">'x_min'</span>] <span class="op">=</span> x_min</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'ext_dict'</span>][<span class="st">'x_max'</span>] <span class="op">=</span> x_max</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'ext_dict'</span>][<span class="st">'y_min'</span>] <span class="op">=</span> y_min</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>        metadata[<span class="st">'ext_dict'</span>][<span class="st">'y_max'</span>] <span class="op">=</span> y_max</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate UTM coordinates</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>        x_coords <span class="op">=</span> np.linspace(metadata[<span class="st">'ext_dict'</span>][<span class="st">'x_min'</span>], metadata[<span class="st">'ext_dict'</span>][<span class="st">'x_max'</span>], num<span class="op">=</span>refl_shape[<span class="dv">1</span>])</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>        y_coords <span class="op">=</span> np.linspace(metadata[<span class="st">'ext_dict'</span>][<span class="st">'y_min'</span>], metadata[<span class="st">'ext_dict'</span>][<span class="st">'y_max'</span>], num<span class="op">=</span>refl_shape[<span class="dv">0</span>])</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the DataArray with coordinates including 'wavelengths','fwhm', &amp; 'good_wavelengths'</span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>        refl_xr <span class="op">=</span> xr.DataArray(refl_array, dims<span class="op">=</span>[<span class="st">"y"</span>, <span class="st">"x"</span>, <span class="st">"wavelengths"</span>], name<span class="op">=</span><span class="st">"reflectance"</span>,</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>                       coords<span class="op">=</span>{<span class="st">"x"</span>: (<span class="st">"x"</span>, x_coords), <span class="st">"y"</span>: (<span class="st">"y"</span>, y_coords),</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"wavelengths"</span>: (<span class="st">"wavelengths"</span>, wavelengths), </span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"fwhm"</span>: (<span class="st">"wavelengths"</span>, fwhm),</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"good_wavelengths"</span>: (<span class="st">"wavelengths"</span>, good_wavelengths)})</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># "spatial_ref": spatial_ref}) &lt;&lt; this is added w/ ds.rio.write_crs("epsg:32611", inplace=True)</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># InvalidDimensionOrder: Invalid dimension order. Expected order: ('wavelengths', 'y', 'x'). You can use `DataArray.transpose('wavelengths', 'y', 'x')` to reorder your dimensions. Data variable: reflectance</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># refl_xr = refl_xr.transpose('wavelengths', 'y', 'x') # reorder your dimensions. Data variable: reflectance</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the Dataset</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>        ds <span class="op">=</span> xr.Dataset({<span class="st">"reflectance"</span>: refl_xr})</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add metadata as attributes</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> metadata.items():</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'shape'</span>, <span class="st">'extent'</span>, <span class="st">'ext_dict'</span>]:</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                ds.attrs[key] <span class="op">=</span> value</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set 'wavelengths', 'utm_x', and 'utm_y' as indexes</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>        ds <span class="op">=</span> ds.set_index(x<span class="op">=</span><span class="st">"x"</span>, y<span class="op">=</span><span class="st">"y"</span>, wavelengths<span class="op">=</span><span class="st">"wavelengths"</span>)</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-58" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>h5_filepath <span class="op">=</span> <span class="vs">r"</span><span class="dv">.</span><span class="vs">/data/neon_refl"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>h5_filename <span class="op">=</span> <span class="st">"NEON_D13_NIWO_DP3_454000_4431000_reflectance.h5"</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>aop_refl_ds <span class="op">=</span> aop_h5refl2xarray(os.path.join(h5_filepath,h5_filename))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>aop_refl_ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>aop_refl_ds.attrs[<span class="st">'EPSG'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-61" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add spatial reference information to Coordinates as follows (to create an rioxarray)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>aop_refl_ds.rio.write_crs(<span class="ss">f"epsg:</span><span class="sc">{</span>aop_refl_ds<span class="sc">.</span>attrs[<span class="st">'EPSG'</span>]<span class="sc">}</span><span class="ss">"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we can run a couple more pre-processing steps, of 1. scaling the reflectance data by the scale factor (NEON data are saved in an integer format, scaled by 10000, in order to save on space) 2. setting the water vapor absorption windows (defined as “bad band windows”) to NaN. Similar to the EMIT data, “good_wavelengths” are provided as one of the Coordinates in the <code>aop_refl_ds</code> xarray dataset, so we can use that information to keep only the valid wavelengths.</p>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scale by the reflectance scale factor</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>aop_refl_ds[<span class="st">'reflectance'</span>].data <span class="op">=</span> aop_refl_ds[<span class="st">'reflectance'</span>].data<span class="op">/</span>aop_refl_ds.attrs[<span class="st">'scale_factor'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set "bad bands" (water vapor absorption bands) to NaN</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>aop_refl_ds[<span class="st">'reflectance'</span>].data[:,:,aop_refl_ds[<span class="st">'good_wavelengths'</span>].data<span class="op">==</span><span class="fl">0.0</span>] <span class="op">=</span> np.nan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>aop_tile_center <span class="op">=</span> aop_refl_ds.x.values[<span class="bu">int</span>(<span class="bu">len</span>(aop_refl_ds.x)<span class="op">/</span><span class="dv">2</span>)],aop_refl_ds.y.values[<span class="bu">int</span>(<span class="bu">len</span>(aop_refl_ds.y)<span class="op">/</span><span class="dv">2</span>)]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'AOP tile center'</span>,aop_tile_center)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># aop_spectra = aop_refl_ds.sel(x=aop_tile_center[0],y=aop_tile_center[1], method='nearest')</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>aop_point <span class="op">=</span> (<span class="dv">454495</span>,<span class="dv">4431420</span>) <span class="co"># solar panels on MRS building roof</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># aop_point = aop_tile_center</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>aop_spectra <span class="op">=</span> aop_refl_ds.sel(x<span class="op">=</span>aop_point[<span class="dv">0</span>],y<span class="op">=</span>aop_point[<span class="dv">1</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>aop_spectra.hvplot.line(y<span class="op">=</span><span class="st">'reflectance'</span>,x<span class="op">=</span><span class="st">'wavelengths'</span>, color<span class="op">=</span><span class="st">'black'</span>).opts(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f'x = </span><span class="sc">{</span>aop_spectra<span class="sc">.</span>x<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="ss">, y = </span><span class="sc">{</span>aop_spectra<span class="sc">.</span>y<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>aop_refl_ds.hvplot.image(x<span class="op">=</span><span class="st">'x'</span>,y<span class="op">=</span><span class="st">'y'</span>,<span class="op">**</span>size_opts, cmap<span class="op">=</span><span class="st">'viridis'</span>, clim <span class="op">=</span> (<span class="dv">0</span>,<span class="fl">0.5</span>), tiles<span class="op">=</span><span class="st">'ESRI'</span>, xlabel<span class="op">=</span><span class="st">'Longitude'</span>,ylabel<span class="op">=</span><span class="st">'Latitude'</span>,title<span class="op">=</span><span class="st">'NEON AOP Reflectance'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-project</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># aop_refl_ds.rio.reproject('EPSG:4326').hvplot.image(x='x',y='y',**size_opts, cmap='inferno',tiles='ESRI', xlabel='Longitude',ylabel='Latitude',title='NEON AOP Reflectance', crs='EPSG:4326')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the RGB image of the NIWO tile</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>aop_rgb <span class="op">=</span> aop_refl_ds.sel(wavelengths<span class="op">=</span>[<span class="dv">650</span>, <span class="dv">560</span>, <span class="dv">470</span>], method<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>aop_rgb <span class="op">=</span> gamma_adjust(aop_rgb,white_background<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>aop_rgb.hvplot.rgb(x<span class="op">=</span><span class="st">'x'</span>,y<span class="op">=</span><span class="st">'y'</span>,bands<span class="op">=</span><span class="st">'wavelengths'</span>,xlabel<span class="op">=</span><span class="st">'UTM x'</span>,ylabel<span class="op">=</span><span class="st">'UTM y'</span>,title<span class="op">=</span><span class="st">'NEON AOP Reflectance RGB'</span>,frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># emit_rgb = gamma_adjust(emit_rgb,white_background=True)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Interactive Points Plotting</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Modified from https://github.com/auspatious/hyperspectral-notebooks/blob/main/03_EMIT_Interactive_Points.ipynb</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>POINT_LIMIT <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>color_cycle <span class="op">=</span> hv.Cycle(<span class="st">'Category20'</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create RGB Map</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">=</span> aop_rgb.hvplot.rgb(x<span class="op">=</span><span class="st">'x'</span>,y<span class="op">=</span><span class="st">'y'</span>,bands<span class="op">=</span><span class="st">'wavelengths'</span>,fontscale<span class="op">=</span><span class="fl">1.5</span>, xlabel<span class="op">=</span><span class="st">'UTM x'</span>,ylabel<span class="op">=</span><span class="st">'UTM y'</span>,frame_width<span class="op">=</span><span class="dv">480</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a holoviews points array to enable plotting of the clicked points</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>xmid <span class="op">=</span> aop_refl_ds.x.values[<span class="bu">int</span>(<span class="bu">len</span>(aop_refl_ds.x) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>ymid <span class="op">=</span> aop_refl_ds.y.values[<span class="bu">int</span>(<span class="bu">len</span>(aop_refl_ds.y) <span class="op">/</span> <span class="dv">2</span>)]</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> aop_refl_ds.x.values[<span class="dv">0</span>]</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>y0 <span class="op">=</span> aop_refl_ds.y.values[<span class="dv">0</span>]</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># first_point = ([xmid], [ymid], [0])</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>first_point <span class="op">=</span> ([x0], [y0], [<span class="dv">0</span>])</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> hv.Points(first_point, vdims<span class="op">=</span><span class="st">'id'</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>points_stream <span class="op">=</span> hv.streams.PointDraw(</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>points.columns(),</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>points,</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    drag<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    num_objects<span class="op">=</span>POINT_LIMIT,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    styles<span class="op">=</span>{<span class="st">'fill_color'</span>: color_cycle.values[<span class="dv">1</span>:POINT_LIMIT<span class="op">+</span><span class="dv">1</span>], <span class="st">'line_color'</span>: <span class="st">'gray'</span>}</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>posxy <span class="op">=</span> hv.streams.PointerXY(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>clickxy <span class="op">=</span> hv.streams.Tap(source<span class="op">=</span><span class="bu">map</span>, x<span class="op">=</span>xmid, y<span class="op">=</span>ymid)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to build spectral plot of clicked location to show on hover stream plot</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> click_spectra(data):</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    coordinates <span class="op">=</span> []</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> <span class="bu">any</span>(<span class="bu">len</span>(d) <span class="cf">for</span> d <span class="kw">in</span> data.values()):</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        coordinates.append(clicked_points[<span class="dv">0</span>][<span class="dv">0</span>], clicked_points[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        coordinates <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">'x'</span>], data[<span class="st">'y'</span>])]</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    plots <span class="op">=</span> []</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, coords <span class="kw">in</span> <span class="bu">enumerate</span>(coordinates):</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> coords</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># data = emit_ds.sel(longitude=x, latitude=y, method="nearest")</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> aop_refl_ds.sel(x<span class="op">=</span>x, y<span class="op">=</span>y, method<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>        plots.append(</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>            data.hvplot.line(</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span><span class="st">"reflectance"</span>,</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span><span class="st">"wavelengths"</span>,</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color_cycle,</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>        points_stream.data[<span class="st">"id"</span>][i] <span class="op">=</span> i</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hv.Overlay(plots)</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hover_spectra(x,y):</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aop_refl_ds.sel(x<span class="op">=</span>x,y<span class="op">=</span>y,method<span class="op">=</span><span class="st">'nearest'</span>).hvplot.line(y<span class="op">=</span><span class="st">'reflectance'</span>,x<span class="op">=</span><span class="st">'wavelengths'</span>, color<span class="op">=</span><span class="st">'black'</span>, frame_width<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return emit_ds.sel(longitude=x,latitude=y,method='nearest').hvplot.line(y='reflectance',x='wavelengths',</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                                                         color='black', frame_width=400)</span></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Dynamic Maps</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>click_dmap <span class="op">=</span> hv.DynamicMap(click_spectra, streams<span class="op">=</span>[points_stream])</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>hover_dmap <span class="op">=</span> hv.DynamicMap(hover_spectra, streams<span class="op">=</span>[posxy])</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Map and Dynamic Map side by side</span></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>hv.Layout(hover_dmap<span class="op">*</span>click_dmap <span class="op">+</span> <span class="bu">map</span> <span class="op">*</span> points).cols(<span class="dv">2</span>).opts(</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>    hv.opts.Points(active_tools<span class="op">=</span>[<span class="st">'point_draw'</span>], size<span class="op">=</span><span class="dv">10</span>, tools<span class="op">=</span>[<span class="st">'hover'</span>], color<span class="op">=</span><span class="st">'white'</span>, line_color<span class="op">=</span><span class="st">'gray'</span>),</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>    hv.opts.Overlay(show_legend<span class="op">=</span><span class="va">False</span>, show_title<span class="op">=</span><span class="va">False</span>, fontscale<span class="op">=</span><span class="fl">1.5</span>, frame_height<span class="op">=</span><span class="dv">480</span>)</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="contact-info" class="level2">
<h2 class="anchored" data-anchor-id="contact-info">Contact Info:</h2>
<p><strong>Land Processes Distributed Active Archive Center (LP DAAC)</strong><sup>1</sup></p>
<p>Email: LPDAAC@usgs.gov<br>
Voice: +1-866-573-3222<br>
Website: <a href="https://lpdaac.usgs.gov/" class="uri">https://lpdaac.usgs.gov/</a></p>
<p><sup>1</sup>Work performed under USGS contract G15PD00467 for NASA contract NNG14HH33I.</p>
<p><strong>National Ecological Observatory Network (NEON)</strong><sup>2</sup></p>
<p>Website: <a href="https://www.neonscience.org/" class="uri">https://www.neonscience.org/</a><br>
Contact: <a href="https://www.neonscience.org/about/contact-us" class="uri">https://www.neonscience.org/about/contact-us</a><br>
Date last modified: 08-27-2024</p>
<p><sup>2</sup>NEON is a project sponsored by the National Science Foundation and operated by Battelle.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nasa\.github\.io\/VITALS\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>VSWIR Imaging and Thermal Applications, Learning, and Science.</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>